# Upstream自動マージツール 要件定義書

**作成日**: 2025-10-19  
**最終更新日**: 2025-10-19  
**版**: 1.0

---

## 1. 概要

### 1.1 背景と課題

OSSをベースとして独自にカスタマイズしたアプリケーションを開発・運用する上で、本家OSS（Upstream）の更新を定期的に取り込む作業は不可欠である。しかし、マージ作業のたびに独自実装部分でコンフリクトが頻発し、その解決に多くの時間と手間を要している。

### 1.2 目的

本ツールは、Upstreamマージ時に発生するコンフリクトのうち、**「OSS側には変更がなく、あらかじめ指定された独自実装部分で発生したコンフリクト」** を自動的に解決することを目的とする。これにより、マージ作業の工数を大幅に削減し、開発者がより価値のある作業に集中できる環境を構築する。

### 1.3 ターゲットユーザー

本アプリケーションの開発・保守に携わるすべてのエンジニア

- **ツール利用者**: 定期的にUpstreamを取り込む開発者
- **ツール開発・保守者**: ツール自体のロジックを改善・保守する開発者

### 1.4 開発・実行環境

| 項目 | 詳細 |
|------|------|
| 開発言語 | TypeScript |
| 実行基盤 | Bun |
| 配布形態 | `bun build --compile` で生成された単一の実行可能ファイル |
| 実行環境 | ツール利用者は特定の実行環境（Bun、Node.js）のインストール不要 |
| 対応OS | macOS、Windows、Linux |

---

## 2. 機能要件

### 2.1 設定ファイル読み込み機能

#### 概要

ツールは、実行に必要な設定情報をJSON形式のファイルから読み込む。

#### 要件

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-CFG-001 | 設定ファイル配置 | 設定ファイルは `config.json` として、ツール実行ファイルと同じディレクトリに配置される（例: `/scripts/upstream-merge-tool/config.json`） |
| REQ-CFG-002 | 設定ファイル形式 | 設定ファイルはJSON形式である |
| REQ-CFG-003 | 必須設定項目 | 以下の設定項目が必須として定義されている |

#### 設定ファイルの構造

```json
{
  "upstream_repository_name": "upstream",
  "upstream_branch_name": "main",
  "last_merged_upstream_commit": "abc1234567890def",
  "custom_code_marker": {
    "start": "// CUSTOM-CODE-START",
    "end": "// CUSTOM-CODE-END"
  }
}
```

#### 設定項目の詳細

| 項目 | 型 | 必須 | 説明 | 例 |
|------|-----|-----|------|-----|
| `upstream_repository_name` | string | ✓ | Upstreamとして登録しているリモートリポジトリ名 | `"upstream"` |
| `upstream_branch_name` | string | ✓ | マージ対象のUpstreamブランチ名 | `"main"` |
| `last_merged_upstream_commit` | string | ✓ | 前回マージした時点でのUpstreamのコミットハッシュ（SHA-1形式、40文字） | `"abc1234567890def0123456789abcdef01234567"` |
| `custom_code_marker.start` | string | ✓ | 独自実装部分の開始を示す特殊コメント | `"// CUSTOM-CODE-START"` |
| `custom_code_marker.end` | string | ✓ | 独自実装部分の終了を示す特殊コメント | `"// CUSTOM-CODE-END"` |

#### エラーハンドリング

| REQ-CFG-ERR-001 | 設定ファイル存在確認 | `config.json` が存在しない場合、エラーメッセージ「設定ファイルが見つかりません: config.json」を出力して処理を中断する |
| REQ-CFG-ERR-002 | JSON形式検証 | `config.json` のフォーマットが不正な場合、エラーメッセージ「設定ファイルのJSON形式が不正です」を出力して処理を中断する |
| REQ-CFG-ERR-003 | 必須項目検証 | 必須設定項目が不足している場合、不足している項目名を明示したエラーメッセージを出力して処理を中断する |
| REQ-CFG-ERR-004 | コミットハッシュ形式検証 | `last_merged_upstream_commit` がSHA-1形式（40文字の16進数）でない場合、警告メッセージを出力する |

---

### 2.2 Git操作自動化機能

#### 概要

ツールは、Upstreamマージの一連のGitコマンドを自動的に実行し、マージ処理を開始する。

#### 要件

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-GIT-001 | 上流リポジトリ最新化 | `git fetch [upstream_repository_name]` を実行して、Upstreamの最新情報をローカルに取得する |
| REQ-GIT-002 | マージ実行 | `git merge [upstream_repository_name]/[upstream_branch_name]` を実行する |
| REQ-GIT-003 | コンフリクトなしの場合 | マージが成功した場合、「マージが正常に完了しました」というメッセージを表示してツールを終了する |
| REQ-GIT-004 | コンフリクトありの場合 | マージでコンフリクトが発生した場合、「コンフリクトが検出されました。自動解決処理を開始します」と表示し、2.3のコンフリクト自動解決機能に進む |

#### エラーハンドリング

| REQ-GIT-ERR-001 | fetch失敗時 | `git fetch` が失敗した場合、エラーメッセージを出力して処理を中断する |
| REQ-GIT-ERR-002 | merge失敗時 | `git merge` が失敗した場合（コンフリクト以外の理由による失敗）、エラーメッセージを出力して処理を中断する |
| REQ-GIT-ERR-003 | Git実行環境確認 | Gitコマンドが利用不可な場合、「Gitがインストールされていません」というエラーメッセージを出力する |

---

### 2.3 コンフリクト自動解決機能

#### 概要

コンフリクトが発生した各ファイルに対して、指定された条件をすべて満たすかを判定し、条件を満たすコンフリクトを自動的に解決する。

#### 自動解決の条件

コンフリクトを自動解決するには、以下の **3つの条件をすべて満たす** 必要がある：

| 条件ID | 条件 | 詳細 |
|--------|------|------|
| COND-001 | コンフリクト発生 | ファイルにコンフリクトマーカー（`<<<<<<<`, `=======`, `>>>>>>>`）が存在していること |
| COND-002 | Upstream側に変更なし | 対象ファイルが、前回マージしたコミット（`last_merged_upstream_commit`）と今回マージするコミット間で、Upstream側で変更されていないこと |
| COND-003 | 独自実装マーカーで完全に囲まれている | コンフリクト箇所が、`config.json` で指定した独自実装マーカー（`custom_code_marker.start` と `custom_code_marker.end`）で完全に囲まれていること |

#### 処理フロー

```
各コンフリクトファイルに対して:
1. コンフリクトマーカーを検出 (COND-001の判定)
2. git show コマンドでUpstream側の変更状況を確認 (COND-002の判定)
3. 独自実装マーカーの存在確認 (COND-003の判定)

3つの条件をすべて満たした場合:
  → コンフリクト箇所を独自アプリ側の変更で自動解決
  → git add でファイルをステージング
  → ログに記録

1つ以上の条件を満たさない場合:
  → ファイルを手動解決待ちリストに追加
  → ログに記録
```

#### 自動解決処理の詳細

| REQ-AUTO-001 | コンフリクト箇所の検出 | 各コンフリクトファイルから、`<<<<<<<`、`=======`、`>>>>>>>` で囲まれたコンフリクト箇所をすべて検出する |
| REQ-AUTO-002 | Upstream側変更確認 | `git diff [last_merged_upstream_commit]..[upstream_commit]` を実行し、対象ファイルのUpstream側での変更を確認する |
| REQ-AUTO-003 | マーカー検証 | コンフリクト箇所が独自実装マーカーで完全に囲まれているか検証する（マーカーの前後に追加の変更がないこと） |
| REQ-AUTO-004 | 自動解決実行 | 条件を満たす場合、ファイルから独自アプリ側の変更（`<<<<<<< HEAD` から `=======` までの部分）のみを残し、コンフリクトマーカーを削除する |
| REQ-AUTO-005 | ステージング | 解決したファイルに `git add` を実行してステージング状態にする |
| REQ-AUTO-006 | 解決結果記録 | 自動解決したファイル名と解決結果をログに記録する |

#### エラーハンドリング

| REQ-AUTO-ERR-001 | 複数コンフリクト | 1ファイルに複数のコンフリクト箇所がある場合、すべてのコンフリクト箇所を検査し、条件を満たす箇所を自動解決する |
| REQ-AUTO-ERR-002 | マーカーの不一致 | 独自実装マーカーの開始と終了が対応していない場合、そのファイルを手動解決待ちリストに追加する |
| REQ-AUTO-ERR-003 | 部分的な解決 | 1ファイルのコンフリクトが部分的にしか解決できない場合、そのファイルを手動解決待ちリストに追加する |

---

### 2.4 レポート・ログ機能

#### 概要

すべての処理が完了した後、実行結果をユーザーに通知する。

#### 要件

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-REPORT-001 | CLIサマリー表示 | 実行したターミナル上に、処理結果の概要を表示する |
| REQ-REPORT-002 | 詳細ログファイル出力 | 実行ディレクトリに、詳細なレポートをファイルとして生成する（ファイル名形式: `merge-report-YYYYMMDD-HHMMSS.log`） |

#### CLIサマリーの表示内容

処理完了時に、以下の情報をターミナルに表示する：

```
========================================
Upstream マージ処理 完了レポート
========================================
実行日時: YYYY-MM-DD HH:MM:SS
対象リポジトリ: [upstream_repository_name]
対象ブランチ: [upstream_branch_name]

【処理結果】
- 自動解決されたファイル数: X 件
- 手動解決が必要なファイル数: Y 件
- 総コンフリクト数: Z 件

【自動解決されたファイル】
  - file1.ts
  - file2.ts
  ...

【手動解決が必要なファイル】
  - file3.ts
  - file4.ts
  ...

【次のステップ】
1. 手動解決が必要なファイルを確認してください
2. コンフリクトを手動で解決してください
3. git commit を実行してマージを完了してください
4. config.json の last_merged_upstream_commit を更新してください

詳細ログ: ./merge-report-YYYYMMDD-HHMMSS.log
========================================
```

#### 詳細ログファイルの内容

ログファイル `merge-report-YYYYMMDD-HHMMSS.log` には、以下の情報を記録する：

```
[2025-10-19 14:30:45] Upstream マージツール v1.0
[2025-10-19 14:30:45] 設定ファイルを読み込みました: config.json
[2025-10-19 14:30:45] upstream_repository_name: upstream
[2025-10-19 14:30:45] upstream_branch_name: main
[2025-10-19 14:30:45] last_merged_upstream_commit: abc1234567890def...
[2025-10-19 14:30:46] ========== Git 操作開始 ==========
[2025-10-19 14:30:46] git fetch upstream を実行中...
[2025-10-19 14:30:47] ✓ fetch 完了
[2025-10-19 14:30:47] git merge upstream/main を実行中...
[2025-10-19 14:30:48] ⚠ コンフリクトが検出されました
[2025-10-19 14:30:48] ========== コンフリクト自動解決開始 ==========
[2025-10-19 14:30:48] コンフリクトファイル数: 3
[2025-10-19 14:30:48] -----
[2025-10-19 14:30:48] [1/3] file1.ts
[2025-10-19 14:30:48]   条件1 (コンフリクト発生): ✓
[2025-10-19 14:30:48]   条件2 (Upstream側変更なし): ✓
[2025-10-19 14:30:48]   条件3 (マーカーで囲まれている): ✓
[2025-10-19 14:30:48]   → 自動解決しました
[2025-10-19 14:30:48]   → git add file1.ts を実行
[2025-10-19 14:30:49] -----
[2025-10-19 14:30:49] [2/3] file2.ts
[2025-10-19 14:30:49]   条件1 (コンフリクト発生): ✓
[2025-10-19 14:30:49]   条件2 (Upstream側変更なし): ✗ (Upstreamで変更されている)
[2025-10-19 14:30:49]   → 手動解決待ち
[2025-10-19 14:30:49] -----
[2025-10-19 14:30:49] [3/3] file3.ts
[2025-10-19 14:30:49]   条件1 (コンフリクト発生): ✓
[2025-10-19 14:30:49]   条件2 (Upstream側変更なし): ✓
[2025-10-19 14:30:49]   条件3 (マーカーで囲まれている): ✗ (開始マーカーが見つかりません)
[2025-10-19 14:30:49]   → 手動解決待ち
[2025-10-19 14:30:49] ========== 処理結果 ==========
[2025-10-19 14:30:49] 自動解決: 1 件
[2025-10-19 14:30:49] 手動解決待ち: 2 件
[2025-10-19 14:30:49] 総コンフリクト: 3 件
[2025-10-19 14:30:49] ========== 完了 ==========
```

#### エラーハンドリング

| REQ-REPORT-ERR-001 | ログ出力失敗 | ログファイルの生成に失敗した場合、標準エラー出力に警告を出力する |
| REQ-REPORT-ERR-002 | ファイルシステムエラー | ディレクトリへの書き込み権限がない場合、エラーメッセージを出力する |

---

## 3. 非機能要件

### 3.1 配布と実行

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-DIST-001 | 配布形態 | ツールは、リポジトリ内の特定のディレクトリ（例: `/scripts/upstream-merge-tool/`）に配置された単一の実行可能ファイルとして配布される |
| REQ-DIST-002 | 実行方法 | 利用者は、ターミナルから `./scripts/upstream-merge-tool/merge-tool` のように直接ファイルを実行するだけでツールを利用できる |
| REQ-DIST-003 | 環境依存排除 | ツール利用者は、Bun、Node.jsといった特定の実行環境のインストール不要である |
| REQ-DIST-004 | ファイル命名 | macOS/Linux用: `merge-tool`、Windows用: `merge-tool.exe` |

### 3.2 クロスプラットフォーム対応

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-CROSS-001 | 対応OS | ツールは、macOS、Windows、Linuxで動作すること |
| REQ-CROSS-002 | OS別実行ファイル | 各OS向けの実行可能ファイルを個別にビルドし、リポジトリに含めること |
| REQ-CROSS-003 | パス区切り文字 | OSのパス区切り文字の違いに対応すること（Windows: `\`, macOS/Linux: `/`） |
| REQ-CROSS-004 | 改行コード | OSの改行コードの違いに対応すること（Windows: `\r\n`, macOS/Linux: `\n`） |

### 3.3 ビルドプロセス（ツール開発者向け）

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-BUILD-001 | ビルドコマンド | ソースコード修正時、開発者は `bun build --compile` コマンドを実行し、各OS向けの実行可能ファイルを再生成する |
| REQ-BUILD-002 | macOS向けビルド | `bun build [entry-point] --compile --outfile [output-path] --target=bun-darwin-x64` でmacOS向けバイナリを生成 |
| REQ-BUILD-003 | Windows向けビルド | `bun build [entry-point] --compile --outfile [output-path] --target=bun-windows-x64` でWindows向けバイナリを生成 |
| REQ-BUILD-004 | Linux向けビルド | `bun build [entry-point] --compile --outfile [output-path] --target=bun-linux-x64` でLinux向けバイナリを生成 |
| REQ-BUILD-005 | バージョン管理 | 生成された実行可能ファイルは、Gitリポジトリにコミットされ、チーム全体に共有される |

### 3.4 エラーハンドリング

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-ERR-001 | 設定ファイル検証 | `config.json` が存在しない、またはフォーマットが不正な場合、詳細なエラーメッセージを表示して処理を中断する |
| REQ-ERR-002 | Git操作失敗 | Gitコマンドの実行に失敗した場合、その旨をログに出力して処理を中断する |
| REQ-ERR-003 | 予期しない例外 | 予期しない例外が発生した場合、スタックトレースと共にログに記録し、ユーザーに通知する |
| REQ-ERR-004 | 部分的失敗 | マージの部分的な失敗（一部ファイルは自動解決したが、他のファイルは失敗）の場合、成功したファイルと失敗したファイルを明確に区別してレポートする |

### 3.5 保守性

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-MAINT-001 | 設定による柔軟性 | 設定ファイルにより、リポジトリ名、ブランチ名、独自実装マーカーをソースコードの変更なしに容易に変更できること |
| REQ-MAINT-002 | コード品質 | ソースコードは可読性と保守性を重視した設計とし、複雑な処理は関数に分割する |
| REQ-MAINT-003 | ドキュメント | ツール開発者向けのドキュメント（セットアップガイド、ビルド手順、アーキテクチャ説明）を整備する |
| REQ-MAINT-004 | ロギング | 処理の各段階で適切なログを出力し、デバッグや問題調査を容易にする |

### 3.6 パフォーマンス

| 要件ID | 要件 | 詳細 |
|--------|------|------|
| REQ-PERF-001 | 実行時間 | ツールの実行時間は、コンフリクトの数に依存するが、1ファイルあたり数秒以内に処理が完了すること（ネットワーク遅延除く） |
| REQ-PERF-002 | メモリ使用量 | 大規模なファイルを扱う場合でも、メモリ使用量を適切に管理し、システムに過度な負荷をかけないこと |
| REQ-PERF-003 | 並列処理 | コンフリクトファイルの処理は、可能な範囲で並列化を検討する |

---

## 4. ユースケース

### 4.1 ツール利用者のシナリオ

**シナリオ**: 定期的にUpstreamの変更を取り込む

#### ステップ

1. **準備確認**
   - Upstreamの変更を取り込みたい自身の作業ブランチにいることを確認する
   - `config.json` に記載されている `last_merged_upstream_commit` が最新化されていることを確認する

2. **ツール実行**
   - ターミナルを開く
   - リポジトリに配置されている実行可能ファイルを実行する
     - macOS/Linux: `./scripts/upstream-merge-tool/merge-tool`
     - Windows: `.\scripts\upstream-merge-tool\merge-tool.exe`

3. **自動処理**
   - ツールが自動で以下を実行する：
     - `git fetch upstream`
     - `git merge upstream/main`
     - コンフリクトの自動解決（条件を満たすものに限る）

4. **結果確認**
   - ターミナルに表示されるサマリーを確認する
   - 出力されたログファイル（`merge-report-YYYYMMDD-HHMMSS.log`）を確認する
   - 手動での解決が必要なファイルを特定する

5. **手動解決**
   - 残ったコンフリクトを手動で解決する（エディタで編集する）
   - 解決後、`git add` でステージングする

6. **マージ完了**
   - `git commit` を実行してマージを完了させる
   - `config.json` の `last_merged_upstream_commit` を、今回マージしたUpstreamの最新コミットハッシュに更新する

---

### 4.2 ツール開発・保守者のシナリオ

**シナリオ**: ツールのロジックを改善し、新バージョンをリリースする

#### ステップ

1. **ソースコード編集**
   - 改善内容に応じて、ツールのソースコード（`.ts` ファイル）を編集する
   - 例: `./scripts/upstream-merge-tool/main.ts` など

2. **動作確認**
   - 編集内容を確認するため、Bunまたはバンドラーでテストを実施する

3. **各OS向けビルド**
   - macOS向け:
     ```bash
     bun build ./scripts/upstream-merge-tool/main.ts --compile \
       --outfile ./scripts/upstream-merge-tool/merge-tool \
       --target=bun-darwin-x64
     ```
   - Windows向け:
     ```bash
     bun build ./scripts/upstream-merge-tool/main.ts --compile \
       --outfile ./scripts/upstream-merge-tool/merge-tool.exe \
       --target=bun-windows-x64
     ```
   - Linux向け:
     ```bash
     bun build ./scripts/upstream-merge-tool/main.ts --compile \
       --outfile ./scripts/upstream-merge-tool/merge-tool \
       --target=bun-linux-x64
     ```

4. **バージョン管理**
   - 更新された実行可能ファイル（`merge-tool`、`merge-tool.exe` など）を `git add` する
   - 変更内容と共にリポジトリにコミットする
   - 必要に応じてタグを付けてリリースする

---

## 5. 受け入れ基準

### 5.1 機能の完成度

- [ ] 設定ファイル（`config.json`）の読み込みが正常に動作する
- [ ] 必須設定項目の検証が正常に動作する
- [ ] Git fetch / merge コマンドが正常に実行される
- [ ] コンフリクトが正常に検出される
- [ ] 3つの条件をすべて満たすコンフリクトが自動解決される
- [ ] 条件を満たさないコンフリクトが手動解決待ちリストに追加される
- [ ] CLIサマリーが正常に表示される
- [ ] ログファイルが正常に生成される

### 5.2 エラーハンドリング

- [ ] `config.json` 存在チェック時のエラーハンドリングが正常に動作する
- [ ] JSON形式の不正チェック時のエラーハンドリングが正常に動作する
- [ ] 必須項目不足時のエラーハンドリングが正常に動作する
- [ ] Git操作失敗時のエラーハンドリングが正常に動作する

### 5.3 クロスプラットフォーム

- [ ] macOS向け実行可能ファイルが正常に動作する
- [ ] Windows向け実行可能ファイルが正常に動作する
- [ ] Linux向け実行可能ファイルが正常に動作する

### 5.4 ドキュメント

- [ ] ユーザー向けのセットアップガイドが完成している
- [ ] 開発者向けのビルド手順ドキュメントが完成している
- [ ] ツールのアーキテクチャ説明が完成している

---

## 6. 関連ドキュメント

- 設計書: `docs/03_design/features/upstream-merge-tool-design.md`（作成予定）
- 実装計画: `docs/04_implementation/plans/upstream-merge-tool/`（作成予定）
- ユーザーガイド: `README.md`（プロジェクトトップレベル）

---

## 版履歴

| 版 | 更新日 | 更新内容 |
|----|--------|---------|
| 1.0 | 2025-10-19 | 初版作成。ユーザー要件をもとに詳細な機能・非機能要件を定義 |
